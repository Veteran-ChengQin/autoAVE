# å¿«é€Ÿå¼€å§‹ - å±æ€§æå–æ”¹è¿›æŒ‡å—

## æ ¸å¿ƒæ”¹è¿›æ¦‚è§ˆ

æœ¬æ¬¡æ›´æ–°å¯¹å±æ€§æå–ç³»ç»Ÿè¿›è¡Œäº†ä¸‰é¡¹é‡è¦æ”¹è¿›ï¼Œä½¿ç³»ç»Ÿèƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†MLLMæœªæå–å±æ€§çš„æƒ…å†µï¼Œå¹¶æä¾›æ›´ç²¾ç»†åŒ–çš„è¯„ä¼°æŒ‡æ ‡ã€‚

---

## æ”¹è¿›1: JSONæ ¼å¼Prompt

### ä»€ä¹ˆæ”¹å˜äº†ï¼Ÿ
- **ä¹‹å‰**ï¼šPromptè¦æ±‚è‡ªç„¶è¯­è¨€å“åº”ï¼Œæ ¼å¼ä¸ä¸€è‡´
- **ç°åœ¨**ï¼šPromptè¦æ±‚JSONæ ¼å¼å“åº”ï¼Œæ ¼å¼ç»Ÿä¸€

### å¯¹ç”¨æˆ·çš„å½±å“
âœ“ æå–ç»“æœæ›´ç¨³å®š  
âœ“ èƒ½å¤Ÿæ˜ç¡®åŒºåˆ†"æœªæå–"å’Œ"æå–ä¸ºç©º"  
âœ“ æ— éœ€ä¿®æ”¹ä»£ç ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆ

### ç¤ºä¾‹

**å•å±æ€§æå–**
```python
# æ—§å“åº”ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰
"The product is red in color"

# æ–°å“åº”ï¼ˆJSONï¼‰
{"value": "red"}

# æœªæå–æ—¶
{"value": ""}
```

**å¤šå±æ€§æå–**
```python
# æ—§å“åº”ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰
"color: red, size: large, material: cotton"

# æ–°å“åº”ï¼ˆJSONï¼‰
{"color": "red", "size": "large", "material": "cotton"}

# éƒ¨åˆ†æœªæå–æ—¶
{"color": "red", "size": "", "material": "cotton"}
```

---

## æ”¹è¿›2: å¥å£®çš„JSONè§£æ

### ä»€ä¹ˆæ”¹å˜äº†ï¼Ÿ
- **ä¹‹å‰**ï¼šåŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„ç®€å•è§£æï¼Œå®¹æ˜“å¤±è´¥
- **ç°åœ¨**ï¼šä¸‰å±‚é€’è¿›å¼è§£æï¼Œå®¹é”™èƒ½åŠ›å¼º

### å¯¹ç”¨æˆ·çš„å½±å“
âœ“ å³ä½¿MLLMè¿”å›æ— æ•ˆJSONä¹Ÿèƒ½å¤„ç†  
âœ“ æ”¯æŒJSONåµŒå…¥åœ¨å…¶ä»–æ–‡æœ¬ä¸­  
âœ“ æ— éœ€ä¿®æ”¹ä»£ç ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆ

### è§£ææµç¨‹
```
1. å°è¯•ç›´æ¥JSONè§£æ
   â†“ (å¤±è´¥)
2. ä»å“åº”ä¸­æå–JSONå¯¹è±¡
   â†“ (å¤±è´¥)
3. è¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆå±æ€§æœªæå–ï¼‰
```

### ç¤ºä¾‹

```python
# åœºæ™¯1ï¼šæ ‡å‡†JSON
response = '{"value": "red"}'
result = extractor._extract_value_from_json_response(response)
# result = "red" âœ“

# åœºæ™¯2ï¼šJSONåµŒå…¥æ–‡æœ¬
response = 'The answer is {"value": "red"} based on the frames'
result = extractor._extract_value_from_json_response(response)
# result = "red" âœ“

# åœºæ™¯3ï¼šæ— æ•ˆJSON
response = 'The color appears to be red'
result = extractor._extract_value_from_json_response(response)
# result = "" (æœªæå–) âœ“
```

---

## æ”¹è¿›3: ç²¾ç»†åŒ–F1è®¡ç®—

### ä»€ä¹ˆæ”¹å˜äº†ï¼Ÿ
- **ä¹‹å‰**ï¼šç®€å•çš„äºŒå…ƒåŒ¹é…ï¼ˆ0æˆ–1ï¼‰ï¼Œæ— æ³•åŒºåˆ†é”™è¯¯ç±»å‹
- **ç°åœ¨**ï¼šåŸºäºTP/FP/FNçš„ç²¾ç»†åŒ–è¯„ä¼°ï¼ŒåŒºåˆ†ä¸‰ç§é”™è¯¯

### å¯¹ç”¨æˆ·çš„å½±å“
âœ“ è·å¾—Precisionã€Recallã€F1ä¸‰ä¸ªæŒ‡æ ‡  
âœ“ èƒ½å¤ŸåŒºåˆ†"æœªæå–"å’Œ"æå–é”™è¯¯"  
âœ“ æ”¯æŒæ•´ä½“ã€åˆ†ç±»ã€åˆ†å±æ€§ä¸‰ä¸ªå±‚çº§çš„è¯„ä¼°  
âœ“ è¾“å‡ºæ›´è¯¦ç»†çš„é”™è¯¯ç»Ÿè®¡

### ä¸‰ç§é”™è¯¯ç±»å‹

| æƒ…å†µ | åˆ†ç±» | è¯´æ˜ |
|------|------|------|
| pred="", label="red" | FN | MLLMæœªèƒ½æå–å±æ€§ |
| pred="blue", label="red" | FN | MLLMæå–é”™è¯¯ |
| pred="red", label="" | FP | è¯¯æŠ¥ï¼ˆå®é™…æ— æ­¤å±æ€§ï¼‰ |
| pred="red", label="red" | TP | æ­£ç¡®æå– |

### è¯„ä¼°æŒ‡æ ‡

```
Precision = TP / (TP + FP)  # æå–ç»“æœçš„å‡†ç¡®ç‡
Recall = TP / (TP + FN)     # æå–çš„å®Œæ•´ç‡
F1 = 2 * P * R / (P + R)    # ç»¼åˆæŒ‡æ ‡
```

### ç¤ºä¾‹

**åœºæ™¯1ï¼šå®Œç¾æå–**
```
predictions = ["red", "large", "cotton"]
labels = ["red", "large", "cotton"]

TP=3, FP=0, FN=0
Precision=1.0, Recall=1.0, F1=1.0 âœ“
```

**åœºæ™¯2ï¼šMLLMæœªæå–æŸä¸ªå±æ€§**
```
predictions = ["red", "", "cotton"]
labels = ["red", "large", "cotton"]

TP=2, FP=0, FN=1
Precision=1.0, Recall=0.6667, F1=0.8
```

**åœºæ™¯3ï¼šæå–é”™è¯¯**
```
predictions = ["blue", "large", "cotton"]
labels = ["red", "large", "cotton"]

TP=2, FP=0, FN=1
Precision=1.0, Recall=0.6667, F1=0.8
```

**åœºæ™¯4ï¼šæ··åˆé”™è¯¯**
```
predictions = ["red", "", "polyester"]
labels = ["red", "large", "cotton"]

TP=1, FP=0, FN=2
Precision=1.0, Recall=0.3333, F1=0.5
```

---

## ä½¿ç”¨æ”¹è¿›çš„ç³»ç»Ÿ

### 1. è¿è¡Œæ¨ç†ï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰
```bash
python main.py --split test --domains beauty sports --max_samples 100
```

### 2. æŸ¥çœ‹è¯„ä¼°ç»“æœ

ç³»ç»Ÿä¼šè‡ªåŠ¨è¾“å‡ºè¯¦ç»†çš„è¯„ä¼°æŒ‡æ ‡ï¼š

```
ğŸ”¹ Overall Metrics:
  Total Samples: 100
  Precision: 0.8500
  Recall: 0.7200
  F1 Score: 0.7800
  Accuracy: 0.7500
  TP: 72, FP: 12, FN: 28

ğŸ”¹ Per-Category Metrics (sorted by F1 descending):
  beauty:
    Count: 50
    Precision: 0.8800, Recall: 0.7600, F1: 0.8150
    Accuracy: 0.8000
    TP: 38, FP: 5, FN: 12
  ...

ğŸ”¹ Per-Attribute Metrics (sorted by F1 descending):
  color:
    Count: 100
    Precision: 0.9000, Recall: 0.8500, F1: 0.8750
    Accuracy: 0.8500
    TP: 85, FP: 10, FN: 15
  ...
```

### 3. åˆ†æç»“æœ

#### ç†è§£Precisionå’ŒRecall
- **Precisioné«˜ï¼ŒRecallä½** â†’ ç³»ç»Ÿä¿å®ˆï¼Œåªæå–æœ‰æŠŠæ¡çš„å±æ€§
- **Precisionä½ï¼ŒRecallé«˜** â†’ ç³»ç»Ÿæ¿€è¿›ï¼Œå€¾å‘äºæå–ä½†å‡†ç¡®ç‡ä¸é«˜
- **éƒ½é«˜** â†’ ç³»ç»Ÿè¡¨ç°ä¼˜ç§€

#### ç†è§£TP/FP/FN
- **FNå¤š** â†’ ç³»ç»Ÿæœªèƒ½æå–è¶³å¤Ÿå¤šçš„å±æ€§ï¼Œéœ€è¦æ”¹è¿›promptæˆ–æ¨¡å‹
- **FPå¤š** â†’ ç³»ç»Ÿè¯¯æŠ¥è¾ƒå¤šï¼Œéœ€è¦æé«˜æå–é˜ˆå€¼
- **éƒ½å°‘** â†’ ç³»ç»Ÿè¡¨ç°ä¼˜ç§€

---

## è‡ªå®šä¹‰FuzzyåŒ¹é…é˜ˆå€¼

### é»˜è®¤è¡Œä¸º
ç³»ç»Ÿä½¿ç”¨**å…¬å…±å‰ç¼€åŒ¹é…**ï¼Œé˜ˆå€¼ä¸º0.5ï¼ˆå³å‰ç¼€é•¿åº¦ >= æ ‡ç­¾é•¿åº¦çš„50%ï¼‰

```python
# ç¤ºä¾‹
custom_fuzzy_match("red", "red color", threshold=0.5)
# å‰ç¼€"red" = 3 >= 0.5*3 = 1.5 âœ“ â†’ True

custom_fuzzy_match("medium", "me", threshold=0.5)
# å‰ç¼€"me" = 2 < 0.5*6 = 3 âœ— â†’ False
```

### è°ƒæ•´é˜ˆå€¼

å¦‚æœæƒ³æ”¹å˜åŒ¹é…ä¸¥æ ¼ç¨‹åº¦ï¼Œä¿®æ”¹`evaluate_results()`è°ƒç”¨ï¼š

```python
# æ›´ä¸¥æ ¼ï¼ˆå‰ç¼€éœ€è¦60%ä»¥ä¸Šï¼‰
metrics = evaluate_results(results, threshold=0.6)

# æ›´å®½æ¾ï¼ˆå‰ç¼€éœ€è¦40%ä»¥ä¸Šï¼‰
metrics = evaluate_results(results, threshold=0.4)
```

---

## æµ‹è¯•æ”¹è¿›

### è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
```bash
python test_improvements.py
```

### æµ‹è¯•å†…å®¹
- âœ“ è‡ªå®šä¹‰FuzzyåŒ¹é…
- âœ“ F1è®¡ç®—ï¼ˆ5ä¸ªåœºæ™¯ï¼‰
- âœ“ JSONè§£æï¼ˆå•å±æ€§å’Œå¤šå±æ€§ï¼‰

### é¢„æœŸè¾“å‡º
```
âœ“ ALL TESTS PASSED
```

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæœ‰äº›å±æ€§è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Ÿ
**A:** è¿™è¡¨ç¤ºMLLMæ— æ³•ä»è§†é¢‘å¸§ä¸­æå–è¯¥å±æ€§ã€‚è¿™è¢«è®°å½•ä¸ºFNï¼ˆå‡è´Ÿä¾‹ï¼‰ï¼Œä¼šé™ä½Recallã€‚

### Q: Precisionä¸ºä»€ä¹ˆä¼šå°äº1.0ï¼Ÿ
**A:** è¿™é€šå¸¸è¡¨ç¤ºç³»ç»Ÿæå–äº†ä¸€äº›å®é™…ä¸Šä¸å­˜åœ¨çš„å±æ€§ï¼ˆFPï¼‰ã€‚æ£€æŸ¥FPçš„å…·ä½“æƒ…å†µï¼Œå¯èƒ½éœ€è¦è°ƒæ•´promptæˆ–æå–ç­–ç•¥ã€‚

### Q: å¦‚ä½•æé«˜Recallï¼Ÿ
**A:** 
1. æ”¹è¿›promptï¼Œæä¾›æ›´æ¸…æ™°çš„æå–æŒ‡å¯¼
2. å¢åŠ å…³é”®å¸§æ•°é‡
3. è°ƒæ•´MLLMçš„temperatureå‚æ•°ï¼ˆå¦‚æœæ”¯æŒï¼‰

### Q: å¦‚ä½•æé«˜Precisionï¼Ÿ
**A:**
1. æé«˜fuzzyåŒ¹é…é˜ˆå€¼ï¼ˆthresholdï¼‰
2. æ”¹è¿›promptï¼Œè¦æ±‚æ›´ä¸¥æ ¼çš„æå–æ ‡å‡†
3. å‡å°‘å…³é”®å¸§æ•°é‡ï¼Œåªä¿ç•™æœ€ç›¸å…³çš„å¸§

### Q: èƒ½å¦åŒæ—¶æé«˜Precisionå’ŒRecallï¼Ÿ
**A:** è¿™é€šå¸¸éœ€è¦æ”¹è¿›æ•´ä¸ªç³»ç»Ÿï¼ˆæ›´å¥½çš„å…³é”®å¸§é€‰æ‹©ã€æ›´å¥½çš„promptã€æ›´å¥½çš„MLLMï¼‰ã€‚åœ¨å®è·µä¸­ï¼Œå¾€å¾€éœ€è¦åœ¨ä¸¤è€…ä¹‹é—´æƒè¡¡ã€‚

---

## ä¸‹ä¸€æ­¥

1. **è¿è¡Œå®Œæ•´è¯„ä¼°**ï¼šåœ¨å®Œæ•´æ•°æ®é›†ä¸Šè¿è¡Œç³»ç»Ÿ
2. **åˆ†æé”™è¯¯**ï¼šæŸ¥çœ‹å…·ä½“çš„FPå’ŒFNæ¡ˆä¾‹ï¼Œæ‰¾å‡ºæ”¹è¿›æ–¹å‘
3. **è°ƒæ•´å‚æ•°**ï¼šæ ¹æ®åˆ†æç»“æœè°ƒæ•´thresholdå’Œå…¶ä»–å‚æ•°
4. **è¿­ä»£ä¼˜åŒ–**ï¼šé‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œé€æ­¥æå‡æ€§èƒ½

---

## ç›¸å…³æ–‡æ¡£

- `IMPROVEMENTS_SUMMARY.md` - è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£
- `test_improvements.py` - å®Œæ•´çš„æµ‹è¯•ä»£ç 
- `evaluation.py` - è¯„ä¼°æ¨¡å—æºä»£ç 
- `qwen_vl_extractor.py` - æå–æ¨¡å—æºä»£ç 
